name: "Build Once, Validate Many, Release One"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  id-token: write      # Required for AWS OIDC authentication in ci-test.yml
  contents: read       # Required for checkout actions
  pull-requests: write # Required for test reporting

jobs:
  # STAGE 1: Build artifact once
  build:
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-build.yml@main
    with:
      service_name: ide-orchestrator
    secrets: inherit

  # STAGE 2: Parallel tests using same artifact
  test-auth:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/auth"
      test_name: "auth"
      timeout: 30
    secrets: inherit

  test-workflow:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration/workflow"
      test_name: "workflow"
      timeout: 30
    secrets: inherit

  test-integration:
    needs: build
    uses: arun4infra/zerotouch-platform/.github/workflows/ci-test.yml@main
    with:
      image_tag: ${{ needs.build.outputs.image_tag }}
      test_suite: "tests/integration"
      test_name: "integration"
      timeout: 30
    secrets: inherit

  # STAGE 3: Release only if ALL tests pass
  release:
    needs: [build, test-auth, test-workflow, test-integration]
    if: github.ref == 'refs/heads/main'
    uses: arun4infra/zerotouch-platform/.github/workflows/release-pipeline.yml@main
    with:
      service_name: ide-orchestrator
      image_tag: ${{ needs.build.outputs.image_tag }}
    secrets: inherit